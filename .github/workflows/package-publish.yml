name: Publish to GitHub Packages

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Select release type"
        required: true
        type: choice
        default: "patch"
        options:
          - major
          - minor
          - patch
          - premajor
          - prerelease
      prerelease_id:
        description: "Select prerelease id (used only if release_type is prerelease)"
        required: false
        type: choice
        default: "alpha"
        options:
          - alpha
          - beta
          - rc

jobs:
  publish:
    runs-on: ubuntu-latest

    # publish ã®ãŸã‚ã®æ¨©é™ã‚’è¨­å®š
    permissions:
      contents: write
      packages: write
      pull-requests: write

    steps:
      # ãƒ–ãƒ©ãƒ³ãƒãŒ release/ ã§å§‹ã¾ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€release/ ä»¥å¤–ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™
      - name: Verify release branch
        if: ${{ !startsWith(github.ref, 'refs/heads/release/') }}
        run: |
          echo "This workflow can only be run on release branches."
          exit 1

      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Check out the repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Git ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å & ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®š
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      # Node.js ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: ./.node-version
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"
          scope: "@mopex"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }} 

      # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: pnpm install

      # ãƒ“ãƒ«ãƒ‰
      - name: Run Build
        run: pnpm run build

      # release branch ç”¨ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
      - name: Bump version for release branch
        id: bump_version
        run: |
          if [ "${{ inputs.release_type }}" = "premajor" ] || [ "${{ inputs.release_type }}" = "prerelease" ]; then
            NEW_VERSION=$(npm version ${{ inputs.release_type }} --preid "${{ inputs.prerelease_id }}" -m "chore: Bump version to %s")
          else
            NEW_VERSION=$(npm version ${{ inputs.release_type }} -m "chore: Bump version to %s")
          fi

          echo "NEW_VERSION=${NEW_VERSION}" >> "$GITHUB_OUTPUT"

      # ã‚³ãƒŸãƒƒãƒˆã¨ã‚¿ã‚°ã‚’ãƒ—ãƒƒã‚·ãƒ¥
      - name: Push commit and tags
        run: git push --follow-tags

      # GitHub Packages ã«å…¬é–‹
      - name: Publish ğŸ
        run: pnpm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # major ã®å ´åˆã®ã¿ã€main åŒæœŸç”¨ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã‚’å®Ÿæ–½
      - name: Bump version to main
        if: ${{ inputs.release_type == 'major' }}
        run: |
          git switch main
          git pull origin main:main
          NEW_VERSION=$(npm version --no-git-tag-version "${{ inputs.release_type }}")
          git log -1
        shell: bash

      # major ã®å ´åˆã®ã¿ã€Pull Request ã‚’ä½œæˆ
      - name: Create Pull Request to main
        if: ${{ inputs.release_type == 'major' }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: chore/version-bump-${{ steps.bump_version.outputs.NEW_VERSION }}
          title: "chore: Bump version to ${{ steps.bump_version.outputs.NEW_VERSION }}"
          commit-message: "chore: Bump version to ${{ steps.bump_version.outputs.NEW_VERSION }}"
          base: main
          body: "Automatically bump version to ${{ steps.bump_version.outputs.NEW_VERSION }}"
          sign-commits: true

      # release note ã®ä½œæˆ
      # release note ã®è¨­å®šã¯ release.yml ã‚’å‚ç…§
      - name: Create GitHub Release (Automatic Notes)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagName = process.env.NEW_VERSION;

            const response = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: tagName,
              generate_release_notes: true,
              draft: false,
              prerelease: (tagName.includes('-')),
            });

            core.info(`Created release: ${response.data.html_url}`);
            core.setOutput("release_id", response.data.id);
            core.setOutput("release_url", response.data.html_url);
        env:
          NEW_VERSION: ${{ steps.bump_version.outputs.NEW_VERSION }}
